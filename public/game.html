<!DOCTYPE html>

<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Game Chạy Vượt Chướng Ngại Vật</title>

  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      background-color: #B3E5FC; /* xanh dương pastel */
    }
    canvas {
      margin-top: 100px;
      background-color: transparent; /* nếu bạn muốn giữ ảnh nền canvas */
    }

    button {
      margin: 10px;
      padding: 10px 20px;
      font-family: 'Press Start 2P', cursive;
      font-size: 14px;
      border-radius: 12px;
      border: none;
      background-color: #ffb6c1;
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }

    button:hover {
      background-color: #ff9fbf;
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0,0,0,0.15);
    }

    button.ghost {
      background-color: transparent;
      color: white;
      border: 2px solid white;
    }

    button.ghost:hover {
      background-color: white;
      color: #ffb6c1;
    }
    
    /* Style cho khu vực chỉnh sửa tên nhân vật */
    #charNameDisplay[contenteditable="true"]:focus {
        border-color: #ffb6c1 !important;
        outline: none;
        background-color: #fce4ec; /* Nền nhẹ khi đang chỉnh sửa */
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7/dist/blazeface.min.js"></script>
</head>
<body>

  <nav style="
    position: fixed; 
    top: 0; left: 0; 
    width: 100%; 
    background-color:#ffb6c1; 
    padding:10px; 
    display:flex; 
    align-items:center; 
    justify-content:space-between; 
    gap:10px; 
    z-index: 1000;
  ">
    <div style="font-family: 'Press Start 2P'; font-size: 20px; color: white;">
      GAME BREAK
    </div>

<div>
  <a href="Trangchu.html"><button class="ghost">Flashcards</button></a>
  <a href="Trang2.html"><button class="ghost">Practice</button></a>
</div>

  </nav>

<canvas id="gameCanvas" width="800" height="400"></canvas>

<div>
  <button id="playBtn">Play</button>
  <button id="pauseBtn">Pause</button>
  <button id="restartBtn">Restart</button>
  <button id="selectCharBtn">Select Character</button> 
</div>

<div id="characterControls" style="
  display:none; 
  margin-top: 10px; 
  align-items: center; 
  justify-content: center; 
  width: 100%;
  padding: 5px; 
">
  <button id="prevCharBtn"> &lt; </button>
  
  <div id="charNameDisplay" 
       style="
         font-family: 'Press Start 2P', cursive; 
         color: #333; 
         margin: 0 15px; 
         font-size: 14px;
         line-height: 1.2; 
         padding: 5px 10px; 
         border: 2px solid transparent; 
         min-width: 150px; 
         text-align: center;
         cursor: pointer;
         outline: none;
       ">Character 1</div>
       
  <button id="nextCharBtn"> &gt; </button>
  <button id="confirmCharBtn" style="background-color: #4CAF50; margin-left: 20px;">Confirm</button>
</div>

<div id="uploadControl" style="margin-top: 15px; display: flex; align-items: center; justify-content: center;">
    <input type="file" id="charFileInput" accept="image/*" style="font-family: 'Press Start 2P', cursive; font-size: 12px;">
    <button id="loadCustomCharBtn" style="margin-left: 10px; background-color: #007bff;">
        Load Custom
    </button>
</div>

<script>
/* ------------------------- CANVAS & CTX ------------------------- */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

/* ---------------------------- BUTTONS (KHAI BÁO TẤT CẢ TẠI ĐÂY) ---------------------------- */
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');
const restartBtn = document.getElementById('restartBtn');
const selectCharBtn = document.getElementById('selectCharBtn'); 

const charControls = document.getElementById('characterControls');
const charNameDisplay = document.getElementById('charNameDisplay');
const prevCharBtn = document.getElementById('prevCharBtn');     
const nextCharBtn = document.getElementById('nextCharBtn');     
const confirmCharBtn = document.getElementById('confirmCharBtn'); 

const charFileInput = document.getElementById('charFileInput');
const loadCustomCharBtn = document.getElementById('loadCustomCharBtn');


/* ---------------------------- CẤU HÌNH NHÂN VẬT ---------------------------- */
const CHARACTER_CONFIGS = [
    { name: "Hiep si Moc", src: 'images/anh1.png', width: 80, height: 80}, 
    { name: "Đoi an", src: 'images/anh4.png', width: 80, height: 80 }, 
    { name: "Cong tua Moc", src: 'images/anh5.png', width: 80, height: 80 },
    { name: "Nhan vien y te", src: 'images/anh6.png', width: 80, height: 80 }
];
let currentPlayerIndex = 0; 
let isSelectingCharacter = false; 

/* ---------------------------- ÂM THANH ---------------------------- */
let bgMusic = new Audio('sounds/bg.mp3');
bgMusic.loop = true;
bgMusic.volume = 0.5;

let jumpSound = new Audio('sounds/jump.mp3');
let hitSound = new Audio('sounds/hit.mp3');
let itemSound = new Audio('sounds/item.mp3');

let gameRunning = false;
let gameOver = false;

/* ---------------------------- PLAYER ---------------------------- */
let player = {
  x: 100,
  y: 0, 
  width: 80,
  height: 80,
  dy: 0,
  gravity: 0.8,
  jumpPower: -18,
  speedBoost: 0
};

/* ---------------------------- ẢNH GAME ---------------------------- */
let playerImg = new Image();
let obstacleImg = new Image();
obstacleImg.src = 'images/anh2.png';
let itemImg = new Image();
itemImg.src = 'images/anh3.png';
let bgImg = new Image();
bgImg.src = 'images/background.jpg';

// Khai báo cho phần AI: Thân người que
const STICK_BODY_IMG_SRC = 'images/stick_body.png'; 
let stickBodyImg = new Image();
// Tải thân người que ngay từ đầu
stickBodyImg.crossOrigin = 'anonymous'; 
stickBodyImg.src = STICK_BODY_IMG_SRC;

/* ---------------------------- GROUND ---------------------------- */
const GRASS_GROUND_RATIO = 0.6806;
function getGrassGroundY() { return canvas.height * GRASS_GROUND_RATIO; }
function getGroundObjectY(objHeight) { return getGrassGroundY() - objHeight; }

/* ---------------------------- HIỂN THỊ LÚC LOAD ---------------------------- */
let bgLoaded = false;
let playerLoaded = false;

bgImg.onload = () => { bgLoaded = true; drawInitial(); };

// Hàm tải ảnh nhân vật
function loadPlayerImage(src) {
    playerLoaded = false; 
    playerImg.src = src;
    playerImg.onload = () => { 
        playerLoaded = true; 
        // Cập nhật kích thước player dựa trên config nhân vật đã chọn
        player.width = CHARACTER_CONFIGS[currentPlayerIndex].width;
        player.height = CHARACTER_CONFIGS[currentPlayerIndex].height;
        player.y = getGroundObjectY(player.height); 
        drawInitial(); 
    };
    playerImg.onerror = () => {
        console.error("Lỗi khi tải ảnh nhân vật: " + src);
        playerLoaded = true; 
        drawInitial(); 
    }
}
// Gọi hàm để tải ảnh nhân vật ban đầu
loadPlayerImage(CHARACTER_CONFIGS[currentPlayerIndex].src); 


function drawInitial() {
  if (!bgLoaded || !playerLoaded) return;
  // Thiết lập vị trí ban đầu (không phải chế độ chọn)
  if (!isSelectingCharacter) player.x = 100;
  
  ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
  ctx.drawImage(playerImg, player.x, player.y, player.width, player.height);
}

/* -------------------------- QUẢN LÝ CHỌN NHÂN VẬT -------------------------- */
function updateCharacterDisplay() {
    const char = CHARACTER_CONFIGS[currentPlayerIndex];
    
    // Cập nhật kích thước player ngay khi chọn nhân vật
    player.width = char.width;
    player.height = char.height;
    
    loadPlayerImage(char.src);
    
    if (charNameDisplay) {
        charNameDisplay.textContent = char.name;
        
        // KIỂM TRA ĐỂ BẬT CHỨC NĂNG CHỈNH SỬA TÊN
        // Nhân vật tùy chỉnh sẽ có src là Data URL (bắt đầu bằng 'data:image/')
        const isCustomChar = char.src.startsWith('data:image/');
        
        if (isCustomChar) {
            charNameDisplay.setAttribute('contenteditable', 'true');
            charNameDisplay.style.borderColor = '#ffb6c1'; // Hiện viền khi chỉnh sửa
            charNameDisplay.title = "Nhấp để đổi tên";
        } else {
            charNameDisplay.setAttribute('contenteditable', 'false');
            charNameDisplay.style.borderColor = 'transparent'; // Ẩn viền
            charNameDisplay.title = "";
        }
    }
}

function nextCharacter() {
    currentPlayerIndex = (currentPlayerIndex + 1) % CHARACTER_CONFIGS.length;
    updateCharacterDisplay();
}

function prevCharacter() {
    currentPlayerIndex = (currentPlayerIndex - 1 + CHARACTER_CONFIGS.length) % CHARACTER_CONFIGS.length;
    updateCharacterDisplay();
}

function toggleSelectMode(activate) {
    isSelectingCharacter = activate;
    
    // Ẩn/Hiện các nút điều khiển chính
    if (playBtn) playBtn.style.display = activate ? 'none' : 'inline-block';
    if (pauseBtn) pauseBtn.style.display = activate ? 'none' : 'inline-block';
    if (restartBtn) restartBtn.style.display = activate ? 'none' : 'inline-block';
    if (selectCharBtn) selectCharBtn.style.display = activate ? 'none' : 'inline-block';

    // Hiện/Ẩn các nút điều khiển nhân vật
    if (charControls) charControls.style.display = activate ? 'flex' : 'none';
    
    // Ẩn/Hiện khu vực tải ảnh tùy chỉnh
    const uploadControl = document.getElementById('uploadControl');
    if (uploadControl) uploadControl.style.display = activate ? 'none' : 'flex';


    if (activate) {
        // Đặt nhân vật vào giữa màn hình
        player.x = canvas.width / 2 - player.width / 2;
        updateCharacterDisplay();
    } else {
        // Trở về vị trí ban đầu
        player.x = 100;
        updateCharacterDisplay(); 
    }
    draw(); 
}

/* -------------------------- LOGIC TẢI ẢNH TÙY CHỌN (VỚI FACE DETECTION) -------------------------- */

async function processCustomCharacter(imgElement) {
    // 1. Tải mô hình BlazeFace
    const faceModel = await blazeface.load();
    const predictions = await faceModel.estimateFaces(imgElement);

    if (predictions.length === 0) {
        alert("Không tìm thấy khuôn mặt nào trong ảnh. Vui lòng thử ảnh khác.");
        return null;
    }

    // Chọn khuôn mặt lớn nhất (thường là khuôn mặt chính)
    let bestPrediction = predictions[0];
    
    // Tọa độ khuôn mặt được phát hiện
    const start = bestPrediction.topLeft;
    const end = bestPrediction.bottomRight;
    const size = [end[0] - start[0], end[1] - start[1]]; 

    // Tính toán khung vuông để cắt (Crop): Lấy chiều lớn nhất làm kích thước cạnh
    const faceSize = Math.max(size[0], size[1]);

    // Thêm một chút padding (10%) để khuôn mặt không bị quá sát
    const padding = faceSize * 0.1; 
    const finalSize = faceSize + 2 * padding;

    // Tọa độ cắt
    const cropX = start[0] - padding;
    const cropY = start[1] - padding;

    // BƯỚC 1: CẮT KHUÔN MẶT
    const faceCanvas = document.createElement('canvas');
    faceCanvas.width = finalSize;
    faceCanvas.height = finalSize;
    const faceCtx = faceCanvas.getContext('2d');

    // Cắt và vẽ khuôn mặt vào canvas (đảm bảo không bị lỗi nếu cropX/Y < 0)
    faceCtx.drawImage(
        imgElement,
        Math.max(0, cropX), Math.max(0, cropY), finalSize, finalSize, 
        0, 0, finalSize, finalSize        
    );
    
    // BƯỚC 2: GHÉP VỚI THÂN NGƯỜI QUE
    const finalCanvas = document.createElement('canvas');
    const finalCharSize = 80; // Kích thước nhân vật game
    finalCanvas.width = finalCharSize;
    finalCanvas.height = finalCharSize;
    const finalCtx = finalCanvas.getContext('2d');

    // Đảm bảo thân người que đã được tải
    if (stickBodyImg.complete) {
        // 1. Vẽ thân người que (dùng làm nền)
        finalCtx.drawImage(stickBodyImg, 0, 0, finalCharSize, finalCharSize); 
    } else {
        // Nếu chưa tải xong, vẽ một hình người que đơn giản thay thế
        finalCtx.fillStyle = '#000000';
        finalCtx.fillRect(finalCharSize/2 - 5, finalCharSize/2, 10, finalCharSize/2);
        finalCtx.beginPath();
        finalCtx.arc(finalCharSize/2, finalCharSize/4, finalCharSize*0.15, 0, Math.PI * 2);
        finalCtx.fill();
    }

    // 2. Vẽ khuôn mặt đã cắt lên trên cùng
    // Điều chỉnh vị trí của khuôn mặt để nó nằm đúng vị trí đầu
    const faceDrawSize = finalCharSize * 0.45; // Khuôn mặt chiếm 45% kích thước
    const faceDrawX = finalCharSize / 2 - faceDrawSize / 2;
    const faceDrawY = finalCharSize * 0.05; 

    finalCtx.drawImage(faceCanvas, faceDrawX, faceDrawY, faceDrawSize, faceDrawSize);

    // Chuyển canvas cuối cùng thành Data URL (giống như ảnh PNG)
    return finalCanvas.toDataURL('image/png');
}

async function loadCustomCharacter() {
    const file = charFileInput.files[0];
    const defaultName = "Custom Char Face";

    if (!file) {
        alert("Vui lòng chọn một file ảnh trước.");
        return;
    }
    
    // Kiểm tra và thông báo nếu thư viện AI chưa tải xong
    if (typeof blazeface === 'undefined') {
        alert("Hệ thống AI đang tải. Vui lòng chờ một chút và thử lại.");
        return;
    }

    const reader = new FileReader();
    reader.onload = async function(e) {
        // Tải ảnh dưới dạng đối tượng Image HTML
        const uploadedImg = new Image();
        uploadedImg.onload = async () => {
            try {
                // Gọi hàm xử lý ảnh AI và Canvas
                const processedSrc = await processCustomCharacter(uploadedImg); 
                
                if (processedSrc) {
                    // Xóa nhân vật tùy chọn cũ 
                    const lastIndex = CHARACTER_CONFIGS.length - 1;
                    if (CHARACTER_CONFIGS[lastIndex] && CHARACTER_CONFIGS[lastIndex].src.startsWith('data:image/')) {
                        CHARACTER_CONFIGS.pop();
                    }

                    // Thêm nhân vật mới đã được xử lý
                    CHARACTER_CONFIGS.push({ 
                        name: defaultName, 
                        src: processedSrc, // Sử dụng ảnh đã được xử lý
                        width: 80, 
                        height: 80
                    });

                    // Chuyển đến nhân vật mới
                    currentPlayerIndex = CHARACTER_CONFIGS.length - 1;
                    updateCharacterDisplay();
                    toggleSelectMode(true); 
                    
                    if (charNameDisplay) {
                        charNameDisplay.focus(); 
                        document.execCommand('selectAll', false, null);
                    }
                }
            } catch (error) {
                alert("Lỗi khi xử lý ảnh. Vui lòng kiểm tra console (F12) để xem chi tiết.");
                console.error("Xử lý ảnh lỗi:", error);
            }
        };
        uploadedImg.src = e.target.result;
    };

    reader.readAsDataURL(file); 
}

/* ---------------------------- CONTROLS ---------------------------- */
function handleJump() {
  const groundY = getGrassGroundY();
  // Chỉ cho phép nhảy khi đang đứng trên mặt đất và trò chơi đang chạy
  if (player.y >= groundY - player.height && gameRunning && !gameOver) {
    player.dy = player.jumpPower;
    jumpSound.currentTime = 0;
    jumpSound.play();
  }
}

// Lắng nghe sự kiện nhấn phím (cho PC/Laptop)
document.addEventListener('keydown', e => {
  if (e.code === 'Space' && !isSelectingCharacter) {
    handleJump();
  }
});

// Lắng nghe sự kiện chạm (cho Mobile/Touchscreen) - FIX LỖI NÚT BẤM
document.addEventListener('touchstart', e => {
    // Kiểm tra xem người dùng có chạm vào nút bấm hoặc thẻ <a> không
    const isButton = e.target.tagName === 'BUTTON' || e.target.closest('a') !== null;
    
    // Chỉ cho phép nhảy khi game đang chạy và không phải là nút bấm
    if (!isButton && gameRunning && !isSelectingCharacter) {
        e.preventDefault(); 
        handleJump();
    }
}, { passive: false }); 

/* ---------------------------- SPAWN ---------------------------- */
let obstacles = [], items = [], frame = 0, gameSpeed = 7, score = 0, animationId;

function spawnObstacle() {
  const h = 50;
  obstacles.push({x: canvas.width, y: getGroundObjectY(h), width: 50, height: h});
}

function spawnItem() {
  let randomY = Math.random() * 200 + 50;
  const groundLimit = getGroundObjectY(50);
  if (randomY > groundLimit) randomY = groundLimit;
  items.push({x: canvas.width, y: randomY, width: 50, height: 50});
}

/* ---------------------------- COLLISION ---------------------------- */
function isColliding(a,b){
  return a.x < b.x + b.width && a.x + a.width > b.x && a.y < b.y + b.height && a.y + a.height > b.y;
}

/* ---------------------------- UPDATE ---------------------------- */
function update(){
  frame++;
  player.dy += player.gravity;
  player.y += player.dy;
  const groundY = getGrassGroundY();
  if(player.y > groundY - player.height){ player.y = groundY - player.height; player.dy = 0; }

  if (frame % 600 === 0) gameSpeed += 0.5; // Tăng tốc độ game

  if(frame % 120 === 0) spawnObstacle();
  if(frame % 300 === 0) spawnItem();

  obstacles.forEach((obs,i)=>{
    obs.x -= gameSpeed + player.speedBoost;
    if(isColliding(player,obs)){ gameOver = true; gameRunning = false; hitSound.play(); }
    if(obs.x + obs.width < 0) obstacles.splice(i,1);
  });

  items.forEach((itm,i)=>{
    itm.x -= gameSpeed + player.speedBoost;
    if(isColliding(player,itm)){
      player.speedBoost = 5;
      setTimeout(()=>player.speedBoost=0,2000);
      items.splice(i,1);
      score +=10;
      itemSound.play();
    }
    if(itm.x + itm.width < 0) items.splice(i,1);
  });
}

/* ---------------------------- DRAW ---------------------------- */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(bgImg,0,0,canvas.width,canvas.height);
  
  if (isSelectingCharacter) {
    // Lớp làm mờ (Overlay) khi ở chế độ chọn
    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)'; 
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }
  
  // Vẽ nhân vật
  ctx.drawImage(playerImg,player.x,player.y,player.width,player.height);
  
  // Vẽ chướng ngại vật/item (FIX: Bỏ điều kiện "&& gameRunning" để chúng không biến mất khi Pause)
  if (!isSelectingCharacter) {
    obstacles.forEach(obs => ctx.drawImage(obstacleImg, obs.x, obs.y, obs.width, obs.height));
    items.forEach(itm => ctx.drawImage(itemImg, itm.x, itm.y, itm.width, itm.height));
  }

  // Hiển thị Score/Game Over
  ctx.textAlign="left";
  ctx.font="20px 'Press Start 2P'";
  ctx.fillStyle="black";
  
  // Hiển thị Score chỉ khi game đang chạy và không ở chế độ chọn
  if (!isSelectingCharacter) {
    ctx.fillText("Score: "+score,20,40);
  }

  if(gameOver){
    ctx.fillStyle='red';
    ctx.font='40px "Press Start 2P"';
    ctx.textAlign='center';
    ctx.fillText('GAME OVER',canvas.width/2,canvas.height/2);
    ctx.font='20px "Press Start 2P"';
    ctx.fillText('Final Score: '+score,canvas.width/2,canvas.height/2 + 50);
  }
}

/* ---------------------------- LOOP ---------------------------- */
function loop(){
  if(gameRunning){ 
    update(); 
    draw(); 
    animationId=requestAnimationFrame(loop); 
  }
  else if (!gameOver && !isSelectingCharacter) {
    draw(); // Vẽ lại màn hình chờ bình thường hoặc màn hình PAUSE
  }
}

/* ---------------------------- GÁN SỰ KIỆN BUTTONS ---------------------------- */
// Logic chơi game
if (playBtn) playBtn.addEventListener('click', ()=>{
  if(gameOver){ restartGame(); return; }
  if(!gameRunning && !isSelectingCharacter){ 
    gameRunning = true; 
    loop(); 
    bgMusic.play().catch(()=>{}); 
  }
});

if (pauseBtn) pauseBtn.addEventListener('click', ()=>{
  gameRunning=false; cancelAnimationFrame(animationId);
  draw(); // Gọi draw() một lần nữa để vẽ lại màn hình PAUSE với các vật thể cố định
});

if (restartBtn) restartBtn.addEventListener('click',restartGame);

// Logic chọn nhân vật
if (selectCharBtn) selectCharBtn.addEventListener('click', ()=>{
    toggleSelectMode(true); 
});

if (prevCharBtn) prevCharBtn.addEventListener('click', prevCharacter);
if (nextCharBtn) nextCharBtn.addEventListener('click', nextCharacter);

if (confirmCharBtn) confirmCharBtn.addEventListener('click', ()=>{
    // 1. Lưu tên nhân vật tùy chỉnh trước khi thoát
    const currentConfig = CHARACTER_CONFIGS[currentPlayerIndex];
    if (currentConfig.src.startsWith('data:image/')) {
        // Lấy tên đã chỉnh sửa, loại bỏ khoảng trắng thừa, và đảm bảo không để trống
        let newName = charNameDisplay.textContent.trim();
        if (newName === "") newName = "Custom Char Face"; 
        
        currentConfig.name = newName; 
    }
    
    // 2. Thoát chế độ chọn
    toggleSelectMode(false); 
});

// Logic tải ảnh tùy chọn
if (loadCustomCharBtn) loadCustomCharBtn.addEventListener('click', loadCustomCharacter);

/* ---------------------------- RESTART ---------------------------- */
function restartGame(){
  gameRunning=false;
  cancelAnimationFrame(animationId);
  player.dy=0; player.speedBoost=0;
  obstacles=[]; items=[]; frame=0; score=0; gameOver=false;
  gameSpeed = 7; 
  player.y = getGroundObjectY(player.height);
  
  toggleSelectMode(false); 
  
  gameRunning=true;
  loop();
  bgMusic.currentTime=0; bgMusic.play();
}

// Chạy màn hình chờ khi vừa load trang
drawInitial();
updateCharacterDisplay(); 
loop();
</script>

</body>
</html>